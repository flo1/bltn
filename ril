#!/bin/sh

ARTICLESDIR="/home/$USER/Documents/Articles/"
STOREDIR="/home/$USER/ReadItLater/"
BROWSERCOMMAND=firefox
#BROWSERCOMMAND=chromium-browser

if [ ! -d "$ARTICLESDIR" ] ; then
	mkdir "$ARTICLESDIR"
fi

if [ ! -d "$STOREDIR" ] ; then
	mkdir "$STOREDIR"
fi

add () {
	cd "$ARTICLESDIR"
	FILENAME=$(echo "$1" | sed "s/\/\//%/g" | cut -d% -f2 | sed "s/\//_/g")
	echo "$1" > "$FILENAME"
}

open () {
	cd "$STOREDIR"
	K=1
	for I in * ; do
		echo "$K" \| "$I"
		K=$(( $K+1 ))
	done

	echo Enter the number of the article you want to read:
	read NUMBER

	K=1
	for I in * ; do
		if [ "$K" -eq "$NUMBER" ] ; then
			cd "$I"
			if [ ! "$(ls | grep html$)" = "" ] ; then
				$BROWSERCOMMAND *.html
			fi
			if [ ! "$(ls | grep htm$)" = "" ] ; then
				$BROWSERCOMMAND *.htm
			fi
			cd ..
		fi
		K=$(( $K+1 ))
	done
}

remove () {
	list
	cd "$ARTICLESDIR"
	if [ ! "$(ls)" = "" ] ; then
		echo Enter the number of the article you want to remove:
		read NUMBER

		K=1
		for ARTICLE in * ; do  
			if [ "$K" -eq "$NUMBER" ] ; then
				rm "$ARTICLE"
			fi
			K=$(( $K+1 ))
		done
	fi
}

list () {
	cd "$ARTICLESDIR"
	if [ ! "$(ls)" = "" ] ; then
		K=1
		for ARTICLE in * ; do  
			echo "$K" \| $(cat "$ARTICLE")
			K=$(( $K+1 ))
		done
	else
		echo No article saved
	fi
}

download () {
	cd "$ARTICLESDIR"
	if [ ! "$(ls)" = "" ] ; then
		for FILE in * ; do
			cd "$STOREDIR"
			if [ ! -d "$FILE" ] ; then
				mkdir "$FILE"
				LINK="$(cat "$ARTICLESDIR"/"$FILE")"
				echo Download "$LINK"
				wget -nd -E -H -K -k -p -q -P "$FILE" "$LINK"
			fi
		done
	fi
}

clean () {
	cd "$STOREDIR"
	if [ ! "$(ls)" = "" ] ; then
		for DIR in * ; do
			J=0
			cd "$ARTICLESDIR"
			if [ ! "$(ls)" = "" ] ; then
				for FILE in * ; do
					if [ "$DIR" = "$FILE" ] ; then
						J=1
					fi
				done
			fi
			if [ $J -eq 0 ] ; then
			echo Remove "$DIR"
			rm -r "$STOREDIR"/"$DIR"
		fi
	done
	fi
}

update () {
	clean
	download
}

usage () {
	cat << EOF
Use: $(basename $0) [option]
Options:   -h, --help              Display help
           -l, --list              List saved articles
           -u, --update            Update local copy
           -a, --add url [url2â€¦]   Add url(s)
           -o, --open              Open an article
           -r, --remove            Remove an article
EOF
}

if [ $# -eq 0 ] ; then
	echo Error: missing argument
	usage
	exit 0
fi

if [ ! "$1" = "-a" ] && [ ! "$1" = "--add" ] && [ $# -ge 2 ] ; then
	echo Error: to many arguments
	usage
	exit 0
fi

case "$1" in
	"--help"|"-h")
		usage
		exit 0
		;;
	"--list"|"-l")
		list
		;;
	"--add"|"-a")
		if [ $# -eq 1 ] ; then
			echo Error: missing argument
			usage
			exit 0
		fi
		while test $# -ne 1 ; do
			shift
			add "$1"
		done
		update
		;;
	"--remove"|"-r")
		remove "$1"
		;;
	"--open"|"-o")
		open
		;;
	"--update"|"-u")
		update
		;;
	*)
		echo Error: $1 invalid argument
		usage
		exit 0
		;;
esac

